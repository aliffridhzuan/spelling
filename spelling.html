<script>
(() => {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const tipEl = document.getElementById('tip');
  const modeBtn = document.getElementById('modeBtn');
  const modeLabel = document.getElementById('modeLabel');
  const fsBtn = document.getElementById('fsBtn');
  const resetBtn = document.getElementById('resetBtn');

  let W = 0, H = 0;
  let bubbles = [];
  let particles = [];
  let score = 0;
  let toddlerMode = true;
  let lastSpawn = 0;
  let raf;

  function resize() {
    W = canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
    H = canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
    canvas.style.width = window.innerWidth + 'px';
    canvas.style.height = window.innerHeight + 'px';
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  function spawnBubble() {
    const rMin = toddlerMode ? 28 : 20;
    const rMax = toddlerMode ? 70 : 55;
    const r = (rMin + Math.random()*(rMax - rMin)) * devicePixelRatio;
    const x = (r + Math.random() * (W - 2*r));
    const y = H + r + Math.random() * (H*0.2);
    const speed = (toddlerMode ? 0.8 : 1.2) * (0.5 + Math.random()*1.2) * devicePixelRatio;
    const sway = (Math.random()*0.6 + 0.2) * devicePixelRatio;
    const hue = Math.floor(180 + Math.random()*180);
    bubbles.push({x, y, r, speed, sway, t:Math.random()*Math.PI*2, hue});
  }

  function popConfetti(x, y, n=14) {
    for (let i=0;i<n;i++){
      const angle = Math.random()*Math.PI*2;
      const v = (2 + Math.random()*4) * devicePixelRatio;
      particles.push({
        x, y,
        vx: Math.cos(angle)*v,
        vy: Math.sin(angle)*v,
        life: 40 + Math.random()*20,
        hue: Math.floor(180 + Math.random()*180)
      });
    }
  }

  // Audio (simple pop)
  let audioReady = false, AC;
  function primeAudio(){
    if (audioReady) return;
    audioReady = true;
    try { AC = new (window.AudioContext || window.webkitAudioContext)(); } catch {}
  }
  function popSound(){
    if (!AC) return;
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.type = 'triangle';
    o.frequency.setValueAtTime(700, AC.currentTime);
    o.frequency.exponentialRampToValueAtTime(1200, AC.currentTime + 0.05);
    g.gain.setValueAtTime(0.0001, AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, AC.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime + 0.12);
    o.connect(g).connect(AC.destination);
    o.start(); o.stop(AC.currentTime + 0.13);
  }

  // --- NEW: continuous popping state ---
  let isPressing = false;
  let pointer = { x: -1, y: -1 };

  function getPoint(e){
    primeAudio();
    if (e.touches && e.touches.length) {
      return { x: e.touches[0].clientX * devicePixelRatio, y: e.touches[0].clientY * devicePixelRatio };
    } else {
      return { x: e.clientX * devicePixelRatio, y: e.clientY * devicePixelRatio };
    }
  }

  function tryPopAtPoint(px, py){
    // Check bubbles from topmost for natural feel
    for (let i=bubbles.length-1; i>=0; i--){
      const b = bubbles[i];
      const dx = px - b.x, dy = py - b.y;
      // Slightly generous hitbox for toddlers
      const rr = (b.r * 1.05);
      if (dx*dx + dy*dy <= rr*rr){
        bubbles.splice(i,1);
        popConfetti(b.x, b.y, toddlerMode ? 18 : 12);
        popSound();
        score++; scoreEl.textContent = score;
        if (toddlerMode) spawnBubble();
        spawnBubble();
        return true;
      }
    }
    return false;
  }

  function handleDown(e){
    tipEl.style.display = 'none';
    isPressing = true;
    const p = getPoint(e);
    pointer = p;
    tryPopAtPoint(p.x, p.y);
  }
  function handleMove(e){
    const p = getPoint(e);
    pointer = p;
    if (isPressing) tryPopAtPoint(p.x, p.y);
  }
  function handleUp(){
    isPressing = false;
    pointer = {x:-1,y:-1};
  }

  // Mouse
  canvas.addEventListener('mousedown', handleDown);
  window.addEventListener('mousemove', handleMove);
  window.addEventListener('mouseup', handleUp);
  // Touch
  canvas.addEventListener('touchstart', handleDown, {passive:false});
  window.addEventListener('touchmove', handleMove, {passive:false});
  window.addEventListener('touchend', handleUp);

  // Buttons
  modeBtn.addEventListener('click', () => {
    toddlerMode = !toddlerMode;
    modeLabel.textContent = toddlerMode ? 'ON' : 'OFF';
  });
  fsBtn.addEventListener('click', async () => {
    try {
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    } catch {}
  });
  resetBtn.addEventListener('click', () => {
    score = 0; scoreEl.textContent = '0';
    bubbles.length = 0;
    particles.length = 0;
    for (let i=0;i<10;i++) spawnBubble();
    tipEl.style.display = 'grid';
  });

  for (let i=0;i<10;i++) spawnBubble();

  function loop(ts){
    ctx.clearRect(0,0,W,H);

    if (ts - lastSpawn > (toddlerMode ? 700 : 900)) {
      spawnBubble();
      lastSpawn = ts;
    }

    // Draw bubbles
    for (let i=bubbles.length-1; i>=0; i--){
      const b = bubbles[i];
      b.t = (b.t || 0) + 0.02;
      b.y -= b.speed;
      b.x += Math.cos(b.t) * b.sway;

      const g = ctx.createRadialGradient(b.x - b.r*0.3, b.y - b.r*0.3, b.r*0.2, b.x, b.y, b.r);
      g.addColorStop(0, `hsla(${b.hue}, 90%, 70%, 0.95)`);
      g.addColorStop(1, `hsla(${b.hue}, 90%, 50%, 0.25)`);
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();

      ctx.fillStyle = 'rgba(255,255,255,.25)';
      ctx.beginPath(); ctx.arc(b.x - b.r*0.35, b.y - b.r*0.35, b.r*0.25, 0, Math.PI*2); ctx.fill();

      if (b.y + b.r < 0) bubbles.splice(i,1);
    }

    // Particles
    for (let i=particles.length-1; i>=0; i--){
      const p = particles[i];
      p.x += p.vx; p.y += p.vy; p.vy += 0.15 * devicePixelRatio;
      p.life -= 1;
      ctx.fillStyle = `hsl(${p.hue} 90% 70%)`;
      ctx.fillRect(p.x, p.y, 6*devicePixelRatio, 6*devicePixelRatio);
      if (p.life <= 0) particles.splice(i,1);
    }

    raf = requestAnimationFrame(loop);
  }
  raf = requestAnimationFrame(loop);
})();
</script>
